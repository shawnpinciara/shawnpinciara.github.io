<!DOCTYPE html>
<html lang="en">
<head>
    <title>bassman</title>
    <meta name="description" content="Our first page">
    <meta name="keywords" content="html tutorial template">
    <meta charset="utf-8">
    <link rel="stylesheet" href="style.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
</head>

<body>
<p id="pi">aa</p>
</body>
<script type="module">
    import { PitchDetector } from "https://esm.sh/pitchy@4";
    $( document ).ready(function() {
        const audioContext = new window.AudioContext();
        const analyserNode = audioContext.createAnalyser();
        navigator.mediaDevices.getUserMedia({ audio: true }).then((stream) => {
            audioContext.createMediaStreamSource(stream).connect(analyserNode);
            const detector = PitchDetector.forFloat32Array(analyserNode.fftSize);
            const input = new Float32Array(detector.inputLength);
            updatePitch(analyserNode, detector, input, audioContext.sampleRate);
        });
    });


    function updatePitch(analyserNode, detector, input, sampleRate) {
        analyserNode.getFloatTimeDomainData(input);
        const [pitch, clarity] = detector.findPitch(input, sampleRate);

        // document.getElementById("pitch").textContent = `${
        //     Math.round(pitch * 10) / 10
        // } Hz`;
        $("#pi").text(Math.round(pitch * 10) / 10);
        document.getElementById("clarity").textContent = `${Math.round(
            clarity * 100
        )} %`;
        window.setTimeout(
            () => updatePitch(analyserNode, detector, input, sampleRate),
            100
        );
    }

</script>
</html>