<!DOCTYPE html>
<html lang="en">
<head>
    <title>bassman</title>
    <meta name="description" content="Our first page">
    <meta name="keywords" content="html tutorial template">
    <meta charset="utf-8">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js" integrity="sha512-jduERlz7En1IUZR54bqzpNI64AbffZWR//KJgF71SJ8D8/liKFZ+s1RxmUmB+bhCnIfzebdZsULwOrbVB5f3nQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
</head>

<body>
<p id="pi">aa</p>
<button id="resume-button">Resume audio context</button>
</body>
<script type="module">
    import { PitchDetector } from "https://esm.sh/pitchy@4";
    var audioContext;
    var synth;
    var pit;
    $( document ).ready(function() {
        //create a synth and connect it to the main output (your speakers)
    //synth = new Tone.Synth().toDestination();
    synth = new Tone.MonoSynth({
	oscillator: {
		type: "sine"
	}
}).toDestination();
    
    Tone.start();

    //play a middle 'C' for the duration of an 8th note
    
        audioContext = new window.AudioContext();
        const analyserNode = audioContext.createAnalyser();
        navigator.mediaDevices.getUserMedia({ audio: true }).then((stream) => {
            audioContext.createMediaStreamSource(stream).connect(analyserNode);
            const detector = PitchDetector.forFloat32Array(analyserNode.fftSize);
            const input = new Float32Array(detector.inputLength);
            updatePitch(analyserNode, detector, input, audioContext.sampleRate);
        });
    });


    function updatePitch(analyserNode, detector, input, sampleRate) {
        analyserNode.getFloatTimeDomainData(input);
        const [pitch, clarity] = detector.findPitch(input, sampleRate);

        // document.getElementById("pitch").textContent = `${
        //     Math.round(pitch * 10) / 10
        // } Hz`;
        pit = Math.round(pitch * 10) / 10;
        $("#pi").text(pit);
        if (pit>80 && pit<1000) {
            synth.triggerAttackRelease(pit/2, 0.01);
            
        }
        
        // document.getElementById("clarity").textContent = `${Math.round(
        //     clarity * 100
        // )} %`;
        window.setTimeout(
            () => updatePitch(analyserNode, detector, input, sampleRate),
            100
        );
    }

    $("#resume-button").click(function() {
        audioContext.resume();
        synth.triggerAttackRelease(133.5, 0.01);
    });

</script>
</html>