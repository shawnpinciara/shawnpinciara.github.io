<!DOCTYPE html>
<html lang="en">
<head>
    <title>bassman - Livelli P5.js</title>
    <meta name="description" content="P5.js sketch with layers">
    <meta name="keywords" content="p5js, arduino, serial, levels">
    <meta charset="utf-8">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.5.0/p5.min.js" integrity="sha512-WJXVjqeINVpi5XXJ2jn0BSCfp0y80IKrYh731gLRnkAS9TKc5KNt/OfLtu+fCueqdWniouJ1ubM+VI/hbo7POQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.9.0/addons/p5.dom.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.9.0/addons/p5.sound.min.js"></script>
    <script src="https://unpkg.com/p5.touchgui@0.5.2/lib/p5.touchgui.js"></script>
    <script lang="text/javascript" src="https://unpkg.com/simple-web-serial@latest/dist/simple-web-serial.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body>
<div class="w-full h-full flex flex-col p-4 fixed bg-slate-500">
    <div class="w-full h-1/2 flex flex-row">
      <div class="w-3/4 h-full bg-white rounded-lg flex flex-row p-2">
          <div class="canvas w-full h-full" id="p5js_canvas">
              <main></main>
          </div>
      </div>
      <div class="w-1/4 h-full bg-white rounded-lg ml-2 flex flex-col items-end" id="console_box">
            <p class="w-full h-1/12 pl-4 pt-4">Console:</p>
            <div class="w-full h-full p-2 flex flex-col">
                <div class="w-full h-6/12 flex flex-col" id="console_screen" style="visibility: hidden;">
                    <p id="console_0">---</p><p id="console_1">---</p><p id="console_2">---</p><p id="console_3">---</p><p id="console_4">---</p>
                </div>
                <div class="w-full h-4/12 flex flex-row items-center rounded-lg py-6" id="rec_box" style="background-color: rgb(251, 203, 203);">
                  <button class="w-10 h-10 bg-red-600 hover:bg-red-400 py-2 border rounded-full ml-4" onclick="recButtonPressed()">
                    </button>
                    <p class="text-red-600 font-normal text-lg ml-2">Registra:</p>
                </div>
                
                <div class="w-full h-4/12 bg-blue-400 rounded-md p-4 flex flex-col justify-center items-center text-center mt-2">
                    <p class="text-l text-white"> Distanza real time:</p>
                    <p class="text-xl text-white" id="distanza_testo">100</p>
                </div>
                <div class="w-full h-4/12 flex flex-row justify-center items-center text-center mt-2">
                    <div class="w-1/2 h-full outline-2 outline-stone-50 outline-solid bg-green-400 rounded-md p-4 items-center align-middle justify-center" onclick="playGraphAnimation()"><p class="text-l text-white  "> ‚ñ∂</p></div>
                    <div class="w-1/2 h-full outline-4 outline-stone-50 outline-solid bg-green-400 rounded-md p-4 ml-2 items-center align-middle justify-center" onclick="pauseGraphAnimation()"><p class="text-xl text-white" id="distanza_testo">‚ùö ‚ùö</p></div>
                </div>
            </div>
      </div>
    </div>
    
    <div class="w-full h-1/2 flex flex-row pt-1">
        <div class="w-1/2 h-full flex flex-col pr-2 rounded-lg mt-2 p-2 bg-white">       
                  <p class="text-xl font-semibold p-2">La costante elastica:</p>
                  <p class="text-l font-normal text-left p-2"> La costante elastica K √® il parametro che definisce la rigidit√† 
                    di un corpo elastico, come una molla. Essa quantifica la relazione di 
                    proporzionalit√† diretta tra la forza applicata e la deformazione risultante, 
                    come stabilito dalla Legge di Hooke: F = -K ‚Ä¢ Œîx. Un valore elevato di K 
                    indica una maggiore resistenza alla deformazione. <br> <br>
                  <b>üí° Come la misuriamo (Metodo Statico):</b>
                  Prima di far oscillare il sistema, possiamo calcolare K 
                  misurando di quanto si allunga la molla sotto l'effetto di un peso noto (m)</p>
                  <div class="h-full w-full flex flex-row p-2 ">
                    <div class="w-1/2 h-full flex items-center justify-center"> 
                      <!-- https://www.desmos.com/calculator/k9nmebvg1s -->
                       <!-- k\ =\ \frac{F}{\Delta x}=\frac{\left(m\cdot g\right)}{x_{2}-x_{1}}=\frac{\ \ \ \ \ \ \ \ \cdot9.81m/s^{2}}{\cdot} -->
                      <img src="./costante_elastica_formula.png" class="w-3/4"alt="">
                    </div>
                    <div class="w-1/2 h-full flex flex-row pl-4"> 
                      <div class="w-full flex items-center ml-1"><ul class="text-l font-normal text-left p-4 list-disc">Dove:
                        <li><i>m</i> √® la massa del peso (in kg)</li>
                        <li><i>g</i> √® l'accelerazione di gravit√† (circa 9.81 m/s¬≤)</li>
                        <li><i>Œîx</i> √® l'allungamento della molla in metri.</li>
                      </ul></div>
                    </div>
                  </div>
                  
                  <div class="w-full h-3/12 bg-red-400 rounded-md p-4 flex flex-row justify-center items-center text-center mr-2 mb-2">
                    <p class="text-xl text-white mr-2"> Mostra la linea altezza:</p>
                    <div class="w-8 h-8 rounded-md mr-4" style="background-color:indianred;" onclick="showHPeaksPressed()" id="showHPeaksButton"></div>
                  </div>


                                    

        </div>

         <div class="w-1/2 h-full flex flex-col bg-white rounded-lg mt-2 ml-2 p-2 ">
            <div class="w-full h-1/12 pl-2"> 
              <p class="text-xl font-semibold mt-1">Il moto armonico:</p>
              <p class="text-l font-normal text-left pt-4">Quando la forza di richiamo √® proporzionale allo spostamento 
                (come nella nostra molla), il sistema oscilla con un moto armonico semplice.
                 Il grafico in alto visualizza esattamente questo moto: la sua forma d'onda √® una sinusoide.
                La posizione del peso in funzione del tempo t √® descritta dalla seguente equazione: </p>
                <p class="text-xl font-normal text-center mt-2">x(t)=A‚Ä¢cos(œât+œÜ)</p>
                <ul class="text-l font-normal text-left p-4 list-disc ml-2">Dove:
                        <li><i>A</i> (Ampiezza): √à il massimo spostamento dalla posizione di equilibrio. Sul grafico, 
                          corrisponde all'altezza dei picchi dell'onda.</li>
                        <li><i>œâ</i> (Pulsazione): √à la frequenza dell'oscillazione.</li>
                        <li><i>œÜ</i> (Fase iniziale): Indica la posizione di partenza del peso all'istante t=0.</li>
                </ul>
                <p class="text-l font-normal text-left"><b>‚öôÔ∏è Periodo e Frequenza:</b> Il Periodo (T) √® il tempo necessario per compiere un'oscillazione completa (da un picco al successivo). 
                  √à il valore che misuriamo direttamente dal grafico! <br> 
                  La cosa interessante √® che il periodo non dipende dall'ampiezza dell'oscillazione,
               ma solo dalle caratteristiche fisiche del sistema:</p>
                <img src="./tempo_formula.png" class="h-14">
                

                  <!-- <p>Questa formula √® il cuore del nostro esperimento dinamico!
                    Misurando il periodo T dal grafico e conoscendo la massa m, 
                    possiamo ricavare la costante elastica k in un secondo modo, del tutto indipendente dal primo. 
                    Confrontare i due valori di $k$ (statico e dinamico) √® una potente verifica del modello fisico.</p> -->
            </div>

            <div class="w-full h-full"></div>
            <div class="w-full h-3/12 bg-green-400 rounded-md p-4 flex flex-row justify-center items-center text-center mr-2 mb-2">
                    <p class="text-xl text-white mr-2"> Mostra i picchi:</p>
                    <div class="w-8 h-8 rounded-md mr-4" style="background-color: palegreen;" onclick="showPeaksPressed()" id="showPeaksButton"></div>
                    <!-- <p class="text-xl text-white ">Periodo:</p>
                    <p class="text-xl text-white" id="peak_period_text">4s</p> -->
            </div>
         </div>
    </div>
</div>
</body>
    
<script>
  // --- VARIABILI GLOBALI ---
  let gui;
  let w;
  let h;
  let sensor = 9;
  let sensor_readings = [];
  let recButtonState = false;
  let show_peaks = false; // Controlla VPeaksLayer (linee verticali permanenti)
  let show_peaks_h = false; // Controlla HPeaksLayer (linee orizzontali temporanee)
  var circle_x = 50;
  var fake_index = 0;
  var lower_distance_range = 0;
  var upper_distance_range = 400;
  var h_min_peak = 0; 
  var h_max_peak = 0; 

  var play = true;

  // Dichiarazione dei livelli (PGraphics)
  let axisLayer;    // Livello 0: Assi (Statico)
  let circleLayer;  // Livello 1: Traccia del cerchio (reset a fine schermo)
  let vPeaksLayer;  // Livello 2: Picchi Verticali (reset a fine corsa)
  let hPeaksLayer;  // Livello 3: Picchi Orizzontali (reset ad ogni nuovo picco)


  // --- FUNZIONI DI UTILITY ---
  const connection = SimpleWebSerial.setupSerialConnection({ requestAccessOnPageLoad: true });
  function mapRange(value, inMin, inMax, outMin, outMax){ 
    return outMin + (((value - inMin) / (inMax - inMin)) * (outMax - outMin));
  }

  // --- FUNZIONI DI DISEGNO DEI LIVELLI ---

  // Disegna gli assi una sola volta
  function drawAxes() {
    axisLayer.stroke(2);
    // Freccia verticale
    axisLayer.line(40, 50, 40, h - 30);
    axisLayer.line(40, 50, 40 + 5, 50 + 5);
    axisLayer.line(40, 50, 40 - 5, 50 + 5);
    // Asse orizzontale
    axisLayer.line(40, h - 30, w - 50, h - 30);
    axisLayer.line(w - 50, h - 30, w - 50 - 5, h - 30 - 5);
    axisLayer.line(w - 50, h - 30, w - 50 - 5, h - 30 + 5);
    
    // Etichette 
    axisLayer.fill(0); axisLayer.noStroke(); axisLayer.textSize(12);
    axisLayer.text("Tempo (s)", 400, h - 10); 
    axisLayer.text("Distanza dal suolo (mm)", 60, 50);
  }

  // Funzione chiamata quando si riceve un picco verticale (permanente fino a reset)
  function onVPeakFound() {
      vPeaksLayer.stroke(17, 179, 5); // Verde
      vPeaksLayer.strokeWeight(2);
      vPeaksLayer.line(circle_x-10, 40, circle_x-10, h - 30);
  }

  // Funzione chiamata quando si riceve un picco orizzontale (temporaneo)
  function onHminPeakFound(peakValue) {
      hPeaksLayer.clear(); // Cancella la linea precedente
      
      hPeaksLayer.stroke(255, 100, 0); // Arancione
      hPeaksLayer.strokeWeight(2);
      
      let peak_y = mapRange(peakValue, lower_distance_range, upper_distance_range, h - 50, 50);
      hPeaksLayer.line(50, peak_y, w - 50, peak_y);
  }

  function onHmaxPeakFound(peakValue) {
      hPeaksLayer.clear(); // Cancella la linea precedente
      
      hPeaksLayer.stroke(255, 100, 0); // Arancione
      hPeaksLayer.strokeWeight(2);
      
      let peak_y = mapRange(peakValue, lower_distance_range, upper_distance_range, h - 50, 50);
      hPeaksLayer.line(50, peak_y, w - 50, peak_y);
  }


  // --- EVENT LISTENERS DA ARDUINO (SIMULATI) ---
  connection.on('event-from-arduino', function(data) {
      sensor = data;
      sensor_readings.push(data);
      if (play) {
        document.getElementById("distanza_testo").innerHTML = str(data) + "mm";
      }
      if (sensor_readings.length > 5) {
        sensor_readings.shift();
      }
      if (play) {
        for (let i = 0; i < 5 ; i++) {
          document.getElementById("console_" + str(i)).innerHTML = str(fake_index) + " Distanza: " + str(sensor_readings[i] || '---');
          fake_index += 1;
        }
      }
  });

  connection.on('peak_found', function(data) {
      if (show_peaks) {
          onVPeakFound();
      }
  });

  connection.on('h_min_peak', function(data) {
      if (show_peaks_h) {
          h_min_peak = data;
          onHminPeakFound(data); 
      }
  });
  connection.on('h_min_peak', function(data) {
      if (show_peaks_h) {
          h_min_peak = data;
          onHmaxPeakFound(data); 
      }
  });


  // --- FUNZIONI P5.JS ---
  function setup() {
    textFont('Courier New');
    gui = createGui();
    gui.loadStyle("Blue");
    gui.setFont("Courier New");
    container = document.getElementById('p5js_canvas');
    w = container.offsetWidth;
    h = container.offsetHeight;
    createCanvas(w, h);

    // Inizializza i 4 livelli grafici
    axisLayer = createGraphics(w, h);
    circleLayer = createGraphics(w, h);
    hPeaksLayer = createGraphics(w, h);
    vPeaksLayer = createGraphics(w, h);
    
    // Imposta sfondo e trasparenze iniziali
    circleLayer.background(255); 
    hPeaksLayer.clear();
    vPeaksLayer.clear();
    axisLayer.clear();
    
    // Disegna gli assi una sola volta (Livello 0)
    drawAxes(); 
  }

  function draw() {
    background(255); // Cancella lo sfondo del canvas principale ad ogni frame

    // 1. Logica di spostamento e reset dei livelli persistenti
    if (play) {
      circle_x += 1;
      if (circle_x > w - 50) {
          circle_x = 50;
          circleLayer.background(255); // Reset della traccia
          vPeaksLayer.clear();        // Reset delle linee verticali permanenti
      }
      
      

      // 2. Disegno sul Livello 1 (circleLayer): Traccia persistente
      circleLayer.fill(0, 0, 0); 
      circleLayer.noStroke();
      circleLayer.circle(circle_x, mapRange(sensor, lower_distance_range, upper_distance_range, h - 50, 50), 3);
      
      // 3. Disegno del puntino mobile (sul CANVAS PRINCIPALE, sopra tutto)
      fill(255, 0, 0); 
      noStroke();
      circle(circle_x, mapRange(sensor, lower_distance_range, upper_distance_range, h - 50, 50), 5); 
    }
    
    // 4. Visualizzazione dei Livelli (Ordine dal basso verso l'alto)
    
    image(circleLayer, 0, 0);  // Livello 1: Traccia
    image(vPeaksLayer, 0, 0);  // Livello 2: Linee verticali permanenti
    image(hPeaksLayer, 0, 0);  // Livello 3: Linee orizzontali temporanee
    image(axisLayer, 0, 0);    // Livello 0: Assi (Sotto a tutti)

    drawGui();
  }

  function windowResized() {
    resizeCanvas(windowWidth, windowHeight);
  }

  // --- FUNZIONI BOTTONI ---

  function recButtonPressed() {
    if (recButtonState==false) {
        recButtonState = true;
        document.getElementById("console_screen").style.visibility = "visible";
        document.getElementById("rec_box").style.backgroundColor = "#ffbab5";
        document.getElementById("console_box").style.backgroundColor = "#ffbab5";
        fake_index = 0;
        connection.send('rec_on', 255);
    } else {
        recButtonState = false;
        document.getElementById("console_screen").style.visibility = "hidden"
        document.getElementById("rec_box").style.backgroundColor = "white";
        document.getElementById("console_box").style.backgroundColor = "white";
        connection.send('rec_on', 0);
    }
  }

  function showPeaksPressed() {
    if (show_peaks) {
        show_peaks = false;
        document.getElementById("showPeaksButton").style.backgroundColor = "palegreen";
        hPeaksLayer.clear(); // Cancella la linea precedente
        connection.send('show_peaks', 0);
      
    } else {
        show_peaks = true;
        document.getElementById("showPeaksButton").style.backgroundColor = "forestgreen";
        hPeaksLayer.clear(); // Cancella la linea precedente
        connection.send('show_peaks', 255);
      
    }
  }

  function showHPeaksPressed() {
    if (show_peaks_h) {
      hPeaksLayer.clear();
        show_peaks_h = false;
        document.getElementById("showHPeaksButton").style.backgroundColor = "indianred";
        hPeaksLayer.clear(); // Cancella la linea precedente
      
    } else {
      hPeaksLayer.clear();
        show_peaks_h = true;
        document.getElementById("showHPeaksButton").style.backgroundColor = "darkred";
        hPeaksLayer.clear(); // Cancella la linea precedente
      
    }
  }

  function playGraphAnimation() {
    play = true;
  }

  function pauseGraphAnimation() {
    play=false;

  }
</script>
</html>