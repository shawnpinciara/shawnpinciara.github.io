<!DOCTYPE html>
<html lang="en">
<head>
    <title>bassman</title>
    <meta name="description" content="Our first page">
    <meta name="keywords" content="html tutorial template">
    <meta charset="utf-8">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.5.0/p5.min.js" integrity="sha512-WJXVjqeINVpi5XXJ2jn0BSCfp0y80IKrYh731gLRnkAS9TKc5KNt/OfLtu+fCueqdWniouJ1ubM+VI/hbo7POQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.9.0/addons/p5.dom.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.9.0/addons/p5.sound.min.js"></script>
    <!-- p5.touchgui -->
    <script src="https://unpkg.com/p5.touchgui@0.5.2/lib/p5.touchgui.js"></script>
    <script lang="text/javascript" src="https://unpkg.com/simple-web-serial@latest/dist/simple-web-serial.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

</head>

<body>
<!-- <div class="canvas" style="width: 100%; height: 100%;">
    <main></main>
</div> -->

<div class="w-full h-full flex flex-col p-4 fixed bg-slate-500">
    <!-- ROW -->
     <div class="w-full h-1/2 flex flex-row">
      <div class="w-3/4 h-full bg-white rounded-lg flex flex-row p-2">
          <div class="canvas w-full h-full" id="p5js_canvas">
              <main></main>
          </div>
      </div>
      <div class="w-1/4 h-full bg-white rounded-lg ml-2 flex flex-col items-end" id="console_box">
            <p class="w-full h-1/12 pl-4 pt-4">Console:</p>
            <div class="w-full h-full p-2 flex flex-col items-end">
                <div class="w-full h-6/12 flex flex-col" id="console_screen" style="visibility: hidden;">
                    <p id="console_0">aaa \n sss</p>
                    <p id="console_1">aaaa \n sss</p>
                    <p id="console_2">aaa \n sss</p>
                    <p id="console_3">aaaa \n sss</p>
                    <p id="console_4">aaa \n sss</p>
                </div>
                <div class="w-full h-4/12 flex flex-row items-center rounded-lg py-6" id="rec_box" style="background-color: rgb(251, 203, 203);">
                  <button class="w-10 h-10 bg-red-600 hover:bg-red-400 py-2 border rounded-full ml-4" onclick="recButtonPressed()">
                    </button>
                    <p class="text-red-600 font-normal text-lg ml-2">Registra:</p>
                </div>
                
                <div class="w-full h-4/12 bg-blue-400 rounded-md p-4 flex flex-col justify-center items-center text-center mt-2">
                    <p class="text-l text-white"> Temperatura del sensore (C):</p>
                    <p class="text-xl text-white" id="temperatura_text">100</p>
                    <p class="text-l text-white"> Isteresi (+-C):</p>
                    <p class="text-xl text-white" id="isteresi_text">100</p>
                    <p class="text-l text-white"> Temperatura set (+-C):</p>
                    <p class="text-xl text-white" id="setpoint_text">100</p>
                </div>
                <div class="w-full h-4/12 flex flex-row justify-center items-center text-center mt-2">
                    <div class="w-1/2 h-full outline-2 outline-stone-50 outline-solid bg-green-400 rounded-md p-4 items-center align-middle justify-center" onclick="playGraphAnimation()"><p class="text-l text-white  "> ▶</p></div>
                    <div class="w-1/2 h-full outline-4 outline-stone-50 outline-solid bg-green-400 rounded-md p-4 ml-2 items-center align-middle justify-center" onclick="pauseGraphAnimation()"><p class="text-xl text-white" id="distanza_testo">❚ ❚</p></div>
                </div>
            </div>
            
      </div>
    </div>
    

    

    <!-- ROW -->
    <div class="w-full h-1/2 flex flex-row pt-2">
        <div class="w-full h-full rounded-lg flex items-center">       
                <div class="w-full h-full flex flex-col bg-white rounded-lg mt-2 p-4 pt-10">
                  <p class="text-2xl font-semibold p-2 m2">Il Controllo a Isteresi:</p>
                  <p class="text-l font-normal text-left p-2"> 
                    Il sistema funziona come un termostato intelligente basato su un controllo a retroazione <b>(feedback)</b>. Un sensore misura costantemente la temperatura interna e la confronta con il valore desiderato <b>(Setpoint)</b>. <br>
                    Per evitare che l'elemento riscaldante si accenda e spenga continuamente attorno al valore di setpoint (fenomeno detto chattering), viene utilizzata una isteresi.
                     <br><br>
                    L'<b>isteresi</b> definisce un intervallo di tolleranza. 
                    Il riscaldamento si attiva solo quando la temperatura scende al di 
                    sotto del limite inferiore (Setpoint - Isteresi) e si disattiva solo 
                    quando supera il limite superiore (Setpoint + Isteresi). 
                    Questo garantisce stabilità al sistema e riduce l'usura dei componenti.
                    <br><br>
                    <b>Condizione di ACCENSIONE:</b> &nbsp; &nbsp; &nbsp; T <sub>reale</sub>  <  ( T <sub>setpoint</sub> - T <sub>isteresi</sub> )
                    <br>
                    <b>Condizione di SPEGNIMENTO:</b> &nbsp; &nbsp; &nbsp; T <sub>reale</sub> >  ( T <sub>setpoint</sub> + T <sub>isteresi</sub> )
                    <br> <br>
                    Nota come la temperatura nel grafico non si inverte istantaneamente. 
                    Questo fenomeno è dovuto all'<b>inerzia termica</b>: il sistema impiega del tempo per riscaldarsi e 
                    per raffreddarsi. Per questo motivo, la temperatura potrebbe superare leggermente i limiti dell'isteresi, 
                    creando delle piccole <b>oscillazioni</b> visibili nel grafico. 
                    <br> <br>
                    Per un controllo più preciso, si può sostituire il semplice sistema ON/OFF con un algoritmo <b>PID (Proporzionale-Integrale-Derivativo)</b> . 
                    <br>
                    Questo metodo, un'evoluzione dei sistemi a retroazione negativa, non si limita ad accendere e spegnere ma modula finemente la potenza del riscaldatore. 
                    <br>
                    Analizza l'errore di temperatura attuale (P), quello accumulato (I) e la sua tendenza futura (D). 
                    Per funzionare, richiede un componente elettronico che possa non solo accendere o spegnere la lampadina, ma anche sceglierne l'intensità, garantendo una stabilità termica molto superiore.

                  </p>
                                  
                </div>   
        </div>


    </div>

   
  

</div>
</body>

    
<script>
  let gui;
  let b;
  var sensor = 9;
  let fake_index = 0;
  let img;
  let w;
  let h;
  let sensor_readings = [];
  let recButtonState = false;
  let peak_old = 1;
  let peak_new = 0;
  let show_peaks = false;
  let temperature_setpoint =28;
  let hysteresis = 0.2;
  var circle_x = 50;
  var circle_xs = [];
  var point_color = 0;
  var console_log = []
  var console_text = []
  var console_text_i = 0;
  var console_text_id = 0;
  var lower_temp_range = 20;
  var upper_temp_range = 35;
  var play = false;


  const connection = SimpleWebSerial.setupSerialConnection({
      requestAccessOnPageLoad: true
  });

  // React to incoming events
  connection.on('temperature_setpoint', function(data) {
      console.log('temperature_setpoint ' + data)
      temperature_setpoint = data;
      document.getElementById("setpoint_text").innerHTML = temperature_setpoint.toFixed(2);
  });

  connection.on('hysteresis', function(data) {
      console.log('hysteresis ' + data)
      hysteresis = data;    

      document.getElementById("isteresi_text").innerHTML = hysteresis.toFixed(2);  
  });

  connection.on('temperature_sensor', function(data) {
      console.log('temperature_sensor ' + data)
      sensor = data;    
      document.getElementById("temperatura_text").innerHTML = sensor.toFixed(2);

      sensor_readings.push(data);
      if (sensor_readings.length > 5) {
        sensor_readings.shift();
      }

        for (let i = 0; i < 5 ; i++) {
          document.getElementById("console_" + str(i)).innerHTML = str(fake_index) + " Temperatura: " + str(parseFloat(sensor_readings[i]).toFixed(2));
          fake_index += 1;
        }
      
  });

  connection.on('light_state', function(data) { //se la lue è accesa o no
      console.log('light_state ' + data)

  });

  // Send named events to the Arduino with a number, string, array or json object
  //connection.send('event-to-arduino', "Hello there, Arduino");
  p5.disableFriendlyErrors = false;

  function mapRange(value, inMin, inMax, outMin, outMax){ return outMin + (((value - inMin) / (inMax - inMin)) * (outMax - outMin))}

  function setup() {
    textFont('Courier New');
    gui = createGui();
    gui.loadStyle("Blue");
    gui.setFont("Courier New");
    fill(255,0,0);
    noStroke();
    container = document.getElementById('p5js_canvas');
    w = container.offsetWidth;
    h = container.offsetHeight;
    createCanvas(w, h);
    background(255);
  }
 
  function draw() {

    noStroke();
    fill(255);
    rect(20, 20, w, h-30, 20); //GRAPH

    stroke(2);
    line(40,50,40,h-30); //freccia verticale
    line(40,50,40+5,50+5); //freccia
    line(40,50,40-5,50+5); //freccia
    line(40,h-30,w-50,h-30);
    line(w-50,h-30,w-50-5,h-30-5); //freccia
    line(w-50,h-30,w-50-5,h-30+5); //freccia
    fill(0); noStroke(); textSize(12);
    text("Tempo (s)",400,h-10);
    text("Temperatura (°C)",60,50);

    
    
   

    //puntino nel grafico
    circle_xs[circle_x] = sensor;

    circle_x+=1;
    if (circle_x > 1500) {
      circle_x=0;
      noStroke();
    fill(255);
    rect(20, 20, w, h-30, 20); //GRAPH
    circle_xs = []
          background(255);
    }

    
    for (let i=0; i< 1500; i++) { //disegna tutti i punti
      noStroke();
      fill(point_color,0,0);
      let ii = mapRange(i,0,1500,50,w-50);
      circle(ii,mapRange(circle_xs[i],lower_temp_range,upper_temp_range,h-50,50),3); //puntino grafico

      // fill(255)
      // ii = mapRange(i+1,0,1500,50,w-50);
      // circle(ii,mapRange(circle_xs[(i+1)%1500],lower_temp_range,upper_temp_range,h-50,50),4); //puntino grafico
      // ii = mapRange(i+2,0,1500,50,w-50);
      // circle(ii,mapRange(circle_xs[(i+2)%1500],lower_temp_range,upper_temp_range,h-50,50),4); //puntino grafico
      // ii = mapRange(i+3,0,1500,50,w-50);
      // circle(ii,mapRange(circle_xs[(i+3)%1500],lower_temp_range,upper_temp_range,h-50,50),4); //puntino grafico
      // ii = mapRange(i+4,0,1500,50,w-50);
      // circle(ii,mapRange(circle_xs[(i+4)%1500],lower_temp_range,upper_temp_range,h-50,50),4); //puntino grafico
      // ii = mapRange(i+5,0,1500,50,w-50);
      // circle(ii,mapRange(circle_xs[(i+5)%1500],lower_temp_range,upper_temp_range,h-50,50),4); //puntino grafico
      // ii = mapRange(i+6,0,1500,50,w-50);
      // circle(ii,mapRange(circle_xs[(i+6)%1500],lower_temp_range,upper_temp_range,h-50,50),4); //puntino grafico


    }


    
    //linea temperatura
    stroke(0);
    let temp_ranged = mapRange(temperature_setpoint,lower_temp_range,upper_temp_range,h-50,50);
    line(50, temp_ranged, w-50, temp_ranged);

    //linee isteresi
    stroke(252, 44, 3);
    let hysteresis_range =  mapRange(temperature_setpoint + hysteresis,lower_temp_range,upper_temp_range,h-50,50);
    line(50, hysteresis_range, w-50, hysteresis_range);
    hysteresis_range =  mapRange(temperature_setpoint - hysteresis,lower_temp_range,upper_temp_range,h-50,50);
    line(50, hysteresis_range, w-50, hysteresis_range);
    

    // if () { //REC TOGGLE ON
    //   point_color = 255;
    // } else {
    //   point_color = 0;
    // }

    drawGui();
  }

  function windowResized() {
    resizeCanvas(windowWidth, windowHeight);
  }

  // Find key codes at http://keycode.info/
  function keyPressed() {
    if (keyCode === 82) {
      console.log("R was pressed");
    } else if (keyCode === 67) {
      console.log("C was pressed");
    }
  }

  function recButtonPressed() {
    if (recButtonState==false) {
        recButtonState = true;
        document.getElementById("console_screen").style.visibility = "visible";
        document.getElementById("rec_box").style.backgroundColor = "#ffbab5";
        document.getElementById("console_box").style.backgroundColor = "#ffbab5";
        fake_index = 0;

        connection.send('rec_on', 255);
    } else {
        recButtonState = false;
        document.getElementById("console_screen").style.visibility = "hidden"
        document.getElementById("rec_box").style.backgroundColor = "white";
        document.getElementById("console_box").style.backgroundColor = "white";
        connection.send('rec_on', 0);
    }
  }

  function showPeaksPressed() {
    if (show_peaks) {
        show_peaks = false;
        document.getElementById("showPeaksButton").style.backgroundColor = "palegreen";
    } else {
        show_peaks = true;
        document.getElementById("showPeaksButton").style.backgroundColor = "forestgreen";
    }
  }

  function playGraphAnimation() {
    play = true;
  }

  function pauseGraphAnimation() {
    play=false;

  }


</script>
</html>